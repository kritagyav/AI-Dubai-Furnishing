// Dubai AI Furnishing Platform - Prisma Schema
// Organized by bounded context sections per architecture spec

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════
// IDENTITY & ACCESS
// ═══════════════════════════════════════════

enum UserRole {
  USER
  RETAILER_ADMIN
  RETAILER_STAFF
  AGENT
  CORPORATE_ADMIN
  CORPORATE_EMPLOYEE
  PORTFOLIO_OWNER
  PROPERTY_MANAGER
  PLATFORM_ADMIN
  SUPPORT_AGENT
  HOUSEHOLD_MEMBER
}

model User {
  id              String          @id @default(uuid())
  supabaseAuthId  String          @unique
  email           String          @unique
  name            String?
  avatarUrl       String?
  role            UserRole        @default(USER)
  tenantId        String?
  onboardingPath  OnboardingPath?
  onboardedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  sessions      Session[]
  activityState UserActivityState?

  @@index([supabaseAuthId])
  @@index([tenantId])
}

enum OnboardingPath {
  FURNISH_NOW
  JUST_BROWSING
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  deviceType   String?
  deviceName   String?
  userAgent    String?
  ipAddress    String?
  lastActiveAt DateTime @default(now())
  lastPath     String?
  lastContext  Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastActiveAt(sort: Desc)])
}

model UserActivityState {
  id            String   @id @default(uuid())
  userId        String   @unique
  currentPath   String?
  currentScreen String?
  contextData   Json?
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OfflineAction {
  id             String   @id @default(uuid())
  userId         String
  idempotencyKey String   @unique
  action         String
  payload        Json
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  processedAt    DateTime?
  errorMessage   String?

  @@index([userId, status])
  @@index([idempotencyKey])
}

// ═══════════════════════════════════════════
// ROOM INTELLIGENCE
// ═══════════════════════════════════════════
// Project, Room, RoomScan, RoomPhoto — Future stories

// ═══════════════════════════════════════════
// AI PACKAGES
// ═══════════════════════════════════════════
// Package, PackageItem, PackageReview, PackagePreview — Future stories

// ═══════════════════════════════════════════
// CATALOG & INVENTORY
// ═══════════════════════════════════════════
// Retailer, RetailerProduct, InventoryReservation, CatalogValidation — Future stories

// ═══════════════════════════════════════════
// COMMERCE & ORDERS
// ═══════════════════════════════════════════
// Cart, CartItem, Order, OrderLineItem, Payment — Future stories

// ═══════════════════════════════════════════
// FINANCIAL LEDGER
// ═══════════════════════════════════════════
// LedgerEntry, SettlementBatch, Commission — Future stories

// ═══════════════════════════════════════════
// DELIVERY & FULFILLMENT
// ═══════════════════════════════════════════
// DeliverySchedule, DeliverySlot, DeliveryIssue — Future stories

// ═══════════════════════════════════════════
// ENGAGEMENT & LIFECYCLE
// ═══════════════════════════════════════════
// Notification, SatisfactionSurvey, AbandonedCart, ReEngagementSequence — Future stories

// ═══════════════════════════════════════════
// PLATFORM OPERATIONS
// ═══════════════════════════════════════════
// SupportTicket, FeatureFlag, AIQualityFlag — Future stories

model AuditLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  actorId       String
  actorRole     String
  action        String
  resourceType  String
  resourceId    String
  changes       Json?
  correlationId String?
  ipAddress     String?
  userAgent     String?

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
}

// ═══════════════════════════════════════════
// B2B2C DISTRIBUTION
// ═══════════════════════════════════════════
// AgentPartner, Referral, CorporateAccount, CorporateEmployee — Future stories
