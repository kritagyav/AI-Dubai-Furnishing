// Dubai AI Furnishing Platform - Prisma Schema
// Organized by bounded context sections per architecture spec

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════
// IDENTITY & ACCESS
// ═══════════════════════════════════════════

enum UserRole {
  USER
  RETAILER_ADMIN
  RETAILER_STAFF
  AGENT
  CORPORATE_ADMIN
  CORPORATE_EMPLOYEE
  PORTFOLIO_OWNER
  PROPERTY_MANAGER
  PLATFORM_ADMIN
  SUPPORT_AGENT
  HOUSEHOLD_MEMBER
}

model User {
  id              String          @id @default(uuid())
  supabaseAuthId  String          @unique
  email           String          @unique
  name            String?
  avatarUrl       String?
  role            UserRole        @default(USER)
  tenantId        String?
  onboardingPath  OnboardingPath?
  onboardedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  sessions      Session[]
  activityState UserActivityState?
  projects      Project[]
  retailer      Retailer?

  @@index([supabaseAuthId])
  @@index([tenantId])
}

enum OnboardingPath {
  FURNISH_NOW
  JUST_BROWSING
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  deviceType   String?
  deviceName   String?
  userAgent    String?
  ipAddress    String?
  lastActiveAt DateTime @default(now())
  lastPath     String?
  lastContext  Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastActiveAt(sort: Desc)])
}

model UserActivityState {
  id            String   @id @default(uuid())
  userId        String   @unique
  currentPath   String?
  currentScreen String?
  contextData   Json?
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OfflineAction {
  id             String   @id @default(uuid())
  userId         String
  idempotencyKey String   @unique
  action         String
  payload        Json
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  processedAt    DateTime?
  errorMessage   String?

  @@index([userId, status])
  @@index([idempotencyKey])
}

// ═══════════════════════════════════════════
// ROOM INTELLIGENCE
// ═══════════════════════════════════════════

enum RoomType {
  LIVING_ROOM
  BEDROOM
  DINING_ROOM
  KITCHEN
  BATHROOM
  STUDY_OFFICE
  BALCONY
  OTHER
}

enum RoomTypeSource {
  MANUAL
  AI_SUGGESTED
  AI_CONFIRMED
}

enum DimensionUnit {
  METRIC
  IMPERIAL
}

model Project {
  id           String   @id @default(uuid())
  userId       String
  name         String
  address      String?
  floorPlanUrl      String?
  floorPlanThumbUrl String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms Room[]

  @@index([userId])
}

model Room {
  id             String         @id @default(uuid())
  projectId      String
  name           String
  type           RoomType       @default(OTHER)
  typeConfidence Float?
  typeSource     RoomTypeSource @default(MANUAL)
  widthCm        Int?
  lengthCm       Int?
  heightCm       Int?
  displayUnit    DimensionUnit  @default(METRIC)
  orderIndex     Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos  RoomPhoto[]

  @@index([projectId])
}

model RoomPhoto {
  id           String   @id @default(uuid())
  roomId       String
  storageUrl   String
  thumbnailUrl String?
  orderIndex   Int      @default(0)
  uploadedAt   DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

// ═══════════════════════════════════════════
// AI PACKAGES
// ═══════════════════════════════════════════
// Package, PackageItem, PackageReview, PackagePreview — Future stories

// ═══════════════════════════════════════════
// CATALOG & INVENTORY
// ═══════════════════════════════════════════

enum RetailerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ProductValidationStatus {
  ACTIVE
  PENDING
  REJECTED
}

enum FurnitureCategory {
  SOFA
  BED
  DINING_TABLE
  DINING_CHAIR
  DESK
  OFFICE_CHAIR
  WARDROBE
  DRESSER
  BOOKSHELF
  TV_UNIT
  COFFEE_TABLE
  SIDE_TABLE
  RUG
  CURTAIN
  LIGHTING
  MIRROR
  STORAGE
  OUTDOOR
  DECOR
  OTHER
}

model Retailer {
  id                  String         @id @default(uuid())
  tenantId            String         @unique @default(uuid())
  companyName         String
  tradeLicenseNumber  String
  contactEmail        String
  contactPhone        String?
  businessType        String?
  status              RetailerStatus @default(PENDING)
  rejectionReason     String?
  warehouseDetails    Json?
  documentsUrl        String?
  commissionRate      Int            @default(1200) // basis points (12.00%)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  products RetailerProduct[]

  @@index([tenantId])
  @@index([status])
}

model RetailerProduct {
  id               String                  @id @default(uuid())
  retailerId       String
  tenantId         String
  sku              String
  name             String
  category         FurnitureCategory
  widthCm          Int
  depthCm          Int
  heightCm         Int
  materials        Json                    // string[]
  colors           Json                    // string[]
  priceFils        Int                     // AED in fils (1/100)
  photos           Json                    // string[] of URLs
  stockQuantity    Int                     @default(0)
  validationStatus ProductValidationStatus @default(PENDING)
  validationErrors Json?                   // field-level errors
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@unique([retailerId, sku])
  @@index([tenantId])
  @@index([category, validationStatus])
}

// ═══════════════════════════════════════════
// COMMERCE & ORDERS
// ═══════════════════════════════════════════
// Cart, CartItem, Order, OrderLineItem, Payment — Future stories

// ═══════════════════════════════════════════
// FINANCIAL LEDGER
// ═══════════════════════════════════════════
// LedgerEntry, SettlementBatch, Commission — Future stories

// ═══════════════════════════════════════════
// DELIVERY & FULFILLMENT
// ═══════════════════════════════════════════
// DeliverySchedule, DeliverySlot, DeliveryIssue — Future stories

// ═══════════════════════════════════════════
// ENGAGEMENT & LIFECYCLE
// ═══════════════════════════════════════════
// Notification, SatisfactionSurvey, AbandonedCart, ReEngagementSequence — Future stories

// ═══════════════════════════════════════════
// PLATFORM OPERATIONS
// ═══════════════════════════════════════════
// SupportTicket, FeatureFlag, AIQualityFlag — Future stories

model AuditLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  actorId       String
  actorRole     String
  action        String
  resourceType  String
  resourceId    String
  changes       Json?
  correlationId String?
  ipAddress     String?
  userAgent     String?

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
}

// ═══════════════════════════════════════════
// B2B2C DISTRIBUTION
// ═══════════════════════════════════════════
// AgentPartner, Referral, CorporateAccount, CorporateEmployee — Future stories
