// Dubai AI Furnishing Platform - Prisma Schema
// Organized by bounded context sections per architecture spec

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════
// IDENTITY & ACCESS
// ═══════════════════════════════════════════

enum UserRole {
  USER
  RETAILER_ADMIN
  RETAILER_STAFF
  AGENT
  CORPORATE_ADMIN
  CORPORATE_EMPLOYEE
  PORTFOLIO_OWNER
  PROPERTY_MANAGER
  PLATFORM_ADMIN
  SUPPORT_AGENT
  HOUSEHOLD_MEMBER
}

model User {
  id             String          @id @default(uuid())
  supabaseAuthId String          @unique
  email          String          @unique
  name           String?
  avatarUrl      String?
  role           UserRole        @default(USER)
  tenantId       String?
  onboardingPath OnboardingPath?
  onboardedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  sessions      Session[]
  activityState UserActivityState?
  projects      Project[]
  retailer      Retailer?
  preferences   UserPreference[]

  @@index([supabaseAuthId])
  @@index([tenantId])
}

enum OnboardingPath {
  FURNISH_NOW
  JUST_BROWSING
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  deviceType   String?
  deviceName   String?
  userAgent    String?
  ipAddress    String?
  lastActiveAt DateTime @default(now())
  lastPath     String?
  lastContext  Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastActiveAt(sort: Desc)])
}

model UserActivityState {
  id            String   @id @default(uuid())
  userId        String   @unique
  currentPath   String?
  currentScreen String?
  contextData   Json?
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OfflineAction {
  id             String    @id @default(uuid())
  userId         String
  idempotencyKey String    @unique
  action         String
  payload        Json
  status         String    @default("pending")
  createdAt      DateTime  @default(now())
  processedAt    DateTime?
  errorMessage   String?

  @@index([userId, status])
  @@index([idempotencyKey])
}

// ═══════════════════════════════════════════
// ROOM INTELLIGENCE
// ═══════════════════════════════════════════

enum RoomType {
  LIVING_ROOM
  BEDROOM
  DINING_ROOM
  KITCHEN
  BATHROOM
  STUDY_OFFICE
  BALCONY
  OTHER
}

enum RoomTypeSource {
  MANUAL
  AI_SUGGESTED
  AI_CONFIRMED
}

enum DimensionUnit {
  METRIC
  IMPERIAL
}

enum ProfileType {
  RELOCATOR
  AIRBNB_INVESTOR
  CORPORATE_RELOCATION
  PORTFOLIO_OWNER
}

model Project {
  id                String       @id @default(uuid())
  userId            String
  name              String
  address           String?
  profileType       ProfileType?
  floorPlanUrl      String?
  floorPlanThumbUrl String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms       Room[]
  preferences UserPreference[]

  @@index([userId])
}

model Room {
  id             String         @id @default(uuid())
  projectId      String
  name           String
  type           RoomType       @default(OTHER)
  typeConfidence Float?
  typeSource     RoomTypeSource @default(MANUAL)
  widthCm        Int?
  lengthCm       Int?
  heightCm       Int?
  displayUnit    DimensionUnit  @default(METRIC)
  orderIndex     Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos  RoomPhoto[]

  @@index([projectId])
}

model RoomPhoto {
  id           String   @id @default(uuid())
  roomId       String
  storageUrl   String
  thumbnailUrl String?
  orderIndex   Int      @default(0)
  uploadedAt   DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

// ═══════════════════════════════════════════
// LIFESTYLE DISCOVERY & PREFERENCES
// ═══════════════════════════════════════════

model UserPreference {
  id               String       @id @default(uuid())
  userId           String
  projectId        String
  // Lifestyle quiz (Story 3.1)
  budgetMinFils    Int? // AED in fils
  budgetMaxFils    Int?
  familySize       Int?
  childrenAges     Json? // int[]
  hasPets          Boolean      @default(false)
  petTypes         Json? // string[]
  stylePreferences Json? // string[] — "modern", "traditional", "minimalist", etc.
  quizCompleted    Boolean      @default(false)
  quizStep         Int          @default(0) // auto-save resume point
  // Profile type (Story 3.2) — also on Project for quick access
  profileType      ProfileType?
  // Raw quiz responses for future re-processing
  rawResponses     Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  investorPreference    InvestorPreference?
  childSafetyPreference ChildSafetyPreference?

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

// Story 3.3: Airbnb Investor Target & Revenue Goals
model InvestorPreference {
  id                   String   @id @default(uuid())
  preferenceId         String   @unique
  targetDemographics   Json // string[] — "business_travelers", "families", etc.
  nightlyRateMinFils   Int?
  nightlyRateMaxFils   Int?
  occupancyTargetPct   Int? // 0–100
  investmentBudgetFils Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  preference UserPreference @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
}

// Story 3.4: Child-Safety Requirements
enum SafetyFeature {
  ANCHORED_FURNITURE
  ROUNDED_CORNERS
  NON_TOXIC_FINISHES
  STAIN_RESISTANT_FABRICS
  SAFETY_LOCKS
  SOFT_CLOSE_DRAWERS
  ANTI_TIP_STRAPS
  CORD_COVERS
}

model ChildSafetyPreference {
  id               String   @id @default(uuid())
  preferenceId     String   @unique
  hasChildren      Boolean  @default(true)
  youngestChildAge Int?
  safetyFeatures   Json // SafetyFeature[]
  ageBasedProfile  String? // "toddler", "school_age", "mixed"
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  preference UserPreference @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
}

// ═══════════════════════════════════════════
// AI PACKAGES
// ═══════════════════════════════════════════

enum PackageStatus {
  GENERATING
  READY
  ACCEPTED
  REJECTED
  EXPIRED
}

model Package {
  id             String        @id @default(uuid())
  userId         String
  projectId      String
  roomId         String?
  name           String
  description    String?
  status         PackageStatus @default(GENERATING)
  totalPriceFils Int           @default(0)
  styleTag       String?
  aiModelVersion String?
  generatedAt    DateTime?
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  items    PackageItem[]
  reviews  PackageReview[]
  previews PackagePreview[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
}

model PackageItem {
  id            String @id @default(uuid())
  packageId     String
  productId     String
  quantity      Int    @default(1)
  unitPriceFils Int
  roomPlacement Json? // { x, y, rotation } for room visualization

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
  @@index([productId])
}

model PackageReview {
  id        String   @id @default(uuid())
  packageId String
  userId    String
  rating    Int // 1–5
  comment   String?
  createdAt DateTime @default(now())

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([packageId, userId])
}

model PackagePreview {
  id           String   @id @default(uuid())
  packageId    String
  imageUrl     String
  thumbnailUrl String?
  viewAngle    String? // "top", "perspective", "front"
  createdAt    DateTime @default(now())

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
}

// ═══════════════════════════════════════════
// CATALOG & INVENTORY
// ═══════════════════════════════════════════

enum RetailerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ProductValidationStatus {
  ACTIVE
  PENDING
  REJECTED
}

enum FurnitureCategory {
  SOFA
  BED
  DINING_TABLE
  DINING_CHAIR
  DESK
  OFFICE_CHAIR
  WARDROBE
  DRESSER
  BOOKSHELF
  TV_UNIT
  COFFEE_TABLE
  SIDE_TABLE
  RUG
  CURTAIN
  LIGHTING
  MIRROR
  STORAGE
  OUTDOOR
  DECOR
  OTHER
}

model Retailer {
  id                 String         @id @default(uuid())
  tenantId           String         @unique @default(uuid())
  companyName        String
  tradeLicenseNumber String
  contactEmail       String
  contactPhone       String?
  businessType       String?
  status             RetailerStatus @default(PENDING)
  rejectionReason    String?
  warehouseDetails   Json?
  documentsUrl       String?
  commissionRate     Int            @default(1200) // basis points (12.00%)
  iban               String?
  bankName           String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  userId        String               @unique
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  products      RetailerProduct[]
  syncConfig    InventorySyncConfig?
  syncJobs      InventorySyncJob[]
  commissions   Commission[]
  settlements   Settlement[]
  ledgerEntries LedgerEntry[]
  healthChecks  CatalogHealthCheck[]
  catalogIssues CatalogIssue[]

  @@index([tenantId])
  @@index([status])
}

model RetailerProduct {
  id               String                  @id @default(uuid())
  retailerId       String
  tenantId         String
  sku              String
  name             String
  category         FurnitureCategory
  widthCm          Int
  depthCm          Int
  heightCm         Int
  materials        Json // string[]
  colors           Json // string[]
  priceFils        Int // AED in fils (1/100)
  photos           Json // string[] of URLs
  stockQuantity    Int                     @default(0)
  validationStatus ProductValidationStatus @default(PENDING)
  validationErrors Json? // field-level errors
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@unique([retailerId, sku])
  @@index([tenantId])
  @@index([category, validationStatus])
}

// ═══════════════════════════════════════════
// INVENTORY SYNC — Story 5.3
// ═══════════════════════════════════════════

enum SyncTier {
  BASIC // platform-initiated polling
  PREMIUM // retailer-push webhooks
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  DEAD_LETTER
}

model InventorySyncConfig {
  id                  String    @id @default(uuid())
  retailerId          String    @unique
  tier                SyncTier  @default(BASIC)
  webhookUrl          String? // retailer's endpoint (PREMIUM only)
  webhookSecret       String? // HMAC secret for verification
  pollingInterval     Int       @default(60) // minutes (BASIC only)
  isActive            Boolean   @default(true)
  lastSyncAt          DateTime?
  consecutiveFailures Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
}

model InventorySyncJob {
  id              String        @id @default(uuid())
  retailerId      String
  status          SyncJobStatus @default(PENDING)
  productsUpdated Int           @default(0)
  productsErrored Int           @default(0)
  errorMessage    String?
  retryCount      Int           @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([retailerId])
  @@index([status])
  @@index([retailerId, createdAt(sort: Desc)])
}

// ═══════════════════════════════════════════
// COMMERCE & ORDERS
// ═══════════════════════════════════════════

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  APPLE_PAY
  GOOGLE_PAY
  BANK_TRANSFER
}

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  items CartItem[]

  @@index([userId])
}

model CartItem {
  id        String @id @default(uuid())
  cartId    String
  productId String
  quantity  Int    @default(1)
  priceFils Int // snapshot price at time of add

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  orderRef        String      @unique @default(uuid())
  status          OrderStatus @default(DRAFT)
  subtotalFils    Int         @default(0)
  deliveryFeeFils Int         @default(0)
  totalFils       Int         @default(0)
  shippingAddress Json?
  notes           String?
  paidAt          DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  lineItems OrderLineItem[]
  payments  Payment[]

  @@index([userId])
  @@index([status])
  @@index([orderRef])
}

model OrderLineItem {
  id            String @id @default(uuid())
  orderId       String
  productId     String
  retailerId    String
  productName   String
  sku           String
  quantity      Int
  unitPriceFils Int
  totalFils     Int

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([retailerId])
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amountFils    Int
  currency      String        @default("AED")
  externalRef   String? // Checkout.com payment ID
  failureReason String?
  authorizedAt  DateTime?
  capturedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([externalRef])
}

// ═══════════════════════════════════════════
// FINANCIAL LEDGER — Story 5.5
// ═══════════════════════════════════════════

enum CommissionStatus {
  PENDING
  CLEARED
  SETTLED
  DISPUTED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum LedgerEntryType {
  COMMISSION
  SETTLEMENT_PAYOUT
  ADJUSTMENT
  REFUND
}

model Commission {
  id            String           @id @default(uuid())
  retailerId    String
  orderId       String? // nullable until commerce stories link it
  orderRef      String? // human-readable order reference
  amountFils    Int // commission amount in fils
  rateBps       Int // rate in basis points at time of transaction
  netAmountFils Int // retailer net = product price - commission
  status        CommissionStatus @default(PENDING)
  disputeReason String?
  disputeNotes  String?
  clearedAt     DateTime?
  settledAt     DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  retailer     Retailer    @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  settlement   Settlement? @relation(fields: [settlementId], references: [id])
  settlementId String?

  @@index([retailerId])
  @@index([retailerId, status])
  @@index([settlementId])
}

model Settlement {
  id              String           @id @default(uuid())
  retailerId      String
  totalAmountFils Int // total payout
  commissionCount Int // number of commissions included
  status          SettlementStatus @default(PENDING)
  payoutDate      DateTime?
  transactionRef  String? // external payment reference
  statementUrl    String? // downloadable statement
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  retailer    Retailer     @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  commissions Commission[]

  @@index([retailerId])
  @@index([retailerId, status])
}

model LedgerEntry {
  id          String          @id @default(uuid())
  retailerId  String
  type        LedgerEntryType
  amountFils  Int // positive = credit, negative = debit
  referenceId String? // commission/settlement/adjustment ID
  description String?
  createdAt   DateTime        @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([retailerId])
  @@index([retailerId, createdAt(sort: Desc)])
}

// ═══════════════════════════════════════════
// DELIVERY & FULFILLMENT
// ═══════════════════════════════════════════

enum DeliveryStatus {
  SCHEDULED
  ASSIGNED
  EN_ROUTE
  IN_TRANSIT
  DELIVERED
  FAILED
  RESCHEDULED
}

enum DeliveryIssueType {
  DAMAGED
  WRONG_ITEM
  MISSING_ITEM
  ACCESS_ISSUE
  CUSTOMER_ABSENT
  OTHER
}

model DeliverySchedule {
  id            String         @id @default(uuid())
  orderId       String
  slotId        String?
  status        DeliveryStatus @default(SCHEDULED)
  scheduledDate DateTime
  scheduledSlot String? // e.g., "09:00-12:00"
  driverName    String?
  driverPhone   String?
  vehiclePlate  String?
  trackingUrl   String?
  deliveredAt   DateTime?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  issues DeliveryIssue[]

  @@index([orderId])
  @@index([status])
  @@index([scheduledDate])
}

model DeliverySlot {
  id        String   @id @default(uuid())
  date      DateTime
  startTime String // "09:00"
  endTime   String // "12:00"
  capacity  Int      @default(10)
  booked    Int      @default(0)
  area      String? // Dubai area/district
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([date, startTime, area])
  @@index([date, isActive])
}

model DeliveryIssue {
  id          String            @id @default(uuid())
  deliveryId  String
  type        DeliveryIssueType
  description String
  photoUrls   Json? // string[]
  resolved    Boolean           @default(false)
  resolvedAt  DateTime?
  resolution  String?
  createdAt   DateTime          @default(now())

  delivery DeliverySchedule @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId])
}

// ═══════════════════════════════════════════
// ENGAGEMENT & LIFECYCLE
// ═══════════════════════════════════════════

enum NotificationType {
  ORDER_UPDATE
  DELIVERY_UPDATE
  PACKAGE_READY
  PROMOTION
  SYSTEM
  SURVEY
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

model Notification {
  id        String              @id @default(uuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel @default(IN_APP)
  title     String
  body      String
  data      Json? // action URL, orderId, etc.
  read      Boolean             @default(false)
  readAt    DateTime?
  sentAt    DateTime            @default(now())
  createdAt DateTime            @default(now())

  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
}

model SatisfactionSurvey {
  id            String   @id @default(uuid())
  userId        String
  orderId       String?
  overallScore  Int // 1–5
  deliveryScore Int? // 1–5
  qualityScore  Int? // 1–5
  comment       String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([orderId])
}

model AbandonedCart {
  id             String    @id @default(uuid())
  userId         String
  cartSnapshot   Json // cart items at time of abandonment
  totalFils      Int
  remindersSent  Int       @default(0)
  lastReminderAt DateTime?
  recoveredAt    DateTime?
  createdAt      DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
}

enum SequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model ReEngagementSequence {
  id           String         @id @default(uuid())
  userId       String
  trigger      String // "cart_abandoned", "inactive_30d", etc.
  status       SequenceStatus @default(ACTIVE)
  currentStep  Int            @default(0)
  totalSteps   Int            @default(3)
  nextActionAt DateTime?
  completedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([userId])
  @@index([status, nextActionAt])
}

// ═══════════════════════════════════════════
// CATALOG HEALTH — Story 5.6
// ═══════════════════════════════════════════

enum HealthIssueType {
  STALE_STOCK
  MISSING_FIELDS
  BROKEN_IMAGE
  PRICING_ANOMALY
  LOW_QUALITY_IMAGE
  DUPLICATE_SKU
}

enum HealthIssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model CatalogHealthCheck {
  id            String   @id @default(uuid())
  retailerId    String
  overallScore  Int // 0–100
  totalProducts Int
  issuesFound   Int
  staleProducts Int      @default(0)
  missingFields Int      @default(0)
  brokenImages  Int      @default(0)
  pricingIssues Int      @default(0)
  checkedAt     DateTime @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([retailerId])
  @@index([retailerId, checkedAt(sort: Desc)])
}

model CatalogIssue {
  id             String              @id @default(uuid())
  retailerId     String
  productId      String? // null for retailer-wide issues
  issueType      HealthIssueType
  severity       HealthIssueSeverity
  description    String
  recommendation String?
  resolved       Boolean             @default(false)
  resolvedAt     DateTime?
  createdAt      DateTime            @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([retailerId])
  @@index([retailerId, resolved])
  @@index([productId])
}

// ═══════════════════════════════════════════
// ANALYTICS EVENTS — Story 5.4
// ═══════════════════════════════════════════

model AnalyticsEvent {
  id         String   @id @default(uuid())
  event      String // e.g. "product.viewed", "package.generated", "order.paid"
  userId     String
  properties Json? // event-specific metadata (productId, source, etc.)
  timestamp  DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([event])
  @@index([userId])
  @@index([event, timestamp])
  @@index([userId, event, timestamp])
}

// ═══════════════════════════════════════════
// PLATFORM OPERATIONS
// ═══════════════════════════════════════════

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  ORDER_ISSUE
  DELIVERY_ISSUE
  PRODUCT_QUALITY
  PAYMENT_ISSUE
  ACCOUNT_ISSUE
  GENERAL_INQUIRY
  RETURN_REQUEST
  DISPUTE
  OTHER
}

model SupportTicket {
  id          String         @id @default(uuid())
  ticketRef   String         @unique @default(uuid())
  userId      String
  assigneeId  String?
  category    TicketCategory
  priority    TicketPriority @default(MEDIUM)
  status      TicketStatus   @default(OPEN)
  subject     String
  description String
  orderId     String?
  attachments Json? // string[] of URLs
  resolvedAt  DateTime?
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  messages TicketMessage[]

  @@index([userId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority, status])
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  senderId    String
  senderRole  String // "customer", "support", "system"
  body        String
  attachments Json? // string[]
  createdAt   DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([ticketId, createdAt])
}

model AuditLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  actorId       String
  actorRole     String
  action        String
  resourceType  String
  resourceId    String
  changes       Json?
  correlationId String?
  ipAddress     String?
  userAgent     String?

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
}

// ═══════════════════════════════════════════
// B2B2C DISTRIBUTION
// ═══════════════════════════════════════════

enum AgentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model AgentPartner {
  id                String      @id @default(uuid())
  userId            String      @unique
  companyName       String?
  licenseNumber     String?
  commissionRate    Int         @default(500) // basis points (5.00%)
  status            AgentStatus @default(ACTIVE)
  totalReferrals    Int         @default(0)
  totalEarningsFils Int         @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  referrals Referral[]

  @@index([status])
}

model Referral {
  id             String    @id @default(uuid())
  agentId        String
  referredUserId String?
  referralCode   String    @unique
  orderId        String?
  commissionFils Int       @default(0)
  convertedAt    DateTime?
  createdAt      DateTime  @default(now())

  agent AgentPartner @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([referralCode])
}

model CorporateAccount {
  id           String   @id @default(uuid())
  tenantId     String   @unique @default(uuid())
  companyName  String
  contactEmail String
  contactPhone String?
  maxEmployees Int      @default(50)
  discountBps  Int      @default(0) // discount in basis points
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employees CorporateEmployee[]

  @@index([tenantId])
}

model CorporateEmployee {
  id          String   @id @default(uuid())
  corporateId String
  userId      String   @unique
  employeeRef String? // internal employee ID
  createdAt   DateTime @default(now())

  corporate CorporateAccount @relation(fields: [corporateId], references: [id], onDelete: Cascade)

  @@index([corporateId])
}
